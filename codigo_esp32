#include <WiFi.h>
#include <HTTPClient.h>

const char* ssid = "AnDrew127";
const char* password = "holaamigo";
const String serverURL = "http://192.168.180.197:3000/api/fingerprint";

// Configurar IP estÃ¡tica
IPAddress local_IP(192, 168, 180, 198);
IPAddress gateway(192, 168, 180, 174);
IPAddress subnet(255, 255, 255, 0);

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("ğŸš€ INICIANDO DIAGNÃ“STICO DE CONEXIÃ“N");
  Serial.println("====================================");
  
  // Configurar IP estÃ¡tica
  Serial.println("ğŸ“¡ Configurando IP estÃ¡tica...");
  if (!WiFi.config(local_IP, gateway, subnet)) {
    Serial.println("âŒ Error en configuraciÃ³n IP estÃ¡tica");
  } else {
    Serial.println("âœ… IP estÃ¡tica configurada");
  }
  
  // Conectar WiFi
  Serial.print("ğŸ“¶ Conectando a WiFi: ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, password);
  
  int intentos = 0;
  while (WiFi.status() != WL_CONNECTED && intentos < 20) {
    delay(1000);
    Serial.print(".");
    intentos++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… WiFi CONECTADO!");
    Serial.print("ğŸ“¡ IP del ESP32: ");
    Serial.println(WiFi.localIP());
    Serial.print("ğŸ“¶ SeÃ±al WiFi: ");
    Serial.println(WiFi.RSSI());
    Serial.print("ğŸ”— Gateway: ");
    Serial.println(WiFi.gatewayIP());
  } else {
    Serial.println("\nâŒ ERROR: No se pudo conectar al WiFi");
    return;
  }
  
  delay(2000);
  
  // Prueba 1: ConexiÃ³n bÃ¡sica al servidor
  testConexionBasica();
  
  // Prueba 2: Endpoint especÃ­fico
  testEndpointFingerprint();
  
  // Prueba 3: Endpoint de verificaciÃ³n
  testEndpointVerificar();
}

void loop() {
  // Solo mantener el loop vacÃ­o para diagnÃ³stico
  delay(10000);
}

void testConexionBasica() {
  Serial.println("\nğŸ” PRUEBA 1: ConexiÃ³n bÃ¡sica al servidor");
  Serial.println("========================================");
  
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âŒ WiFi no conectado");
    return;
  }
  
  HTTPClient http;
  String testURL = "http://192.168.180.197:3000/";
  
  Serial.print("ğŸŒ Probando: ");
  Serial.println(testURL);
  
  http.begin(testURL);
  http.setTimeout(15000);
  
  int httpCode = http.GET();
  
  Serial.print("ğŸ“¥ CÃ³digo HTTP: ");
  Serial.println(httpCode);
  
  if (httpCode > 0) {
    String response = http.getString();
    Serial.println("âœ… Â¡SERVIDOR RESPONDE!");
    Serial.print("ğŸ“¨ Respuesta (primeros 200 chars): ");
    Serial.println(response.substring(0, 200));
  } else {
    Serial.println("âŒ NO HAY CONEXIÃ“N CON EL SERVIDOR");
    Serial.print("ğŸ” Error especÃ­fico: ");
    Serial.println(httpCode);
    
    // DiagnÃ³stico de errores comunes
    switch(httpCode) {
      case -1: Serial.println("   - TIMEOUT: El servidor no responde en 15 segundos"); break;
      case -2: Serial.println("   - URL INVÃLIDA: Revisa la IP y puerto"); break;
      case -3: Serial.println("   - PROTOCOLO NO SOPORTADO"); break;
      case -4: Serial.println("   - NO SE PUDO ENCABEZAR LA CONEXIÃ“N"); break;
      case -5: Serial.println("   - REDIRECCIÃ“N DEMASIADO LARGA"); break;
      case -6: Serial.println("   - FALLA EN CONEXIÃ“N TLS/SSL"); break;
      case -7: Serial.println("   - TIEMPO DE LECTURA AGOTADO"); break;
      case -8: Serial.println("   - PAYLOAD DEMASIADO GRANDE"); break;
      case -9: Serial.println("   - ERROR DE ESCRITURA DE STREAM"); break;
      case -10: Serial.println("   - ERROR DE LECTURA DE STREAM"); break;
      default: Serial.println("   - ERROR DESCONOCIDO"); break;
    }
  }
  
  http.end();
}

void testEndpointFingerprint() {
  Serial.println("\nğŸ” PRUEBA 2: Endpoint /api/fingerprint");
  Serial.println("======================================");
  
  HTTPClient http;
  
  Serial.print("ğŸŒ Probando: ");
  Serial.println(serverURL);
  
  http.begin(serverURL);
  http.setTimeout(15000);
  
  int httpCode = http.GET();
  
  Serial.print("ğŸ“¥ CÃ³digo HTTP: ");
  Serial.println(httpCode);
  
  if (httpCode > 0) {
    String response = http.getString();
    Serial.println("âœ… Endpoint responde correctamente");
    Serial.print("ğŸ“¨ Respuesta: ");
    Serial.println(response);
  } else {
    Serial.println("âŒ Endpoint no responde");
  }
  
  http.end();
}

void testEndpointVerificar() {
  Serial.println("\nğŸ” PRUEBA 3: Endpoint de verificaciÃ³n");
  Serial.println("====================================");
  
  HTTPClient http;
  String url = serverURL + "/verificar?finger_id=1";
  
  Serial.print("ğŸŒ Probando: ");
  Serial.println(url);
  
  http.begin(url);
  http.setTimeout(15000);
  
  int httpCode = http.GET();
  
  Serial.print("ğŸ“¥ CÃ³digo HTTP: ");
  Serial.println(httpCode);
  
  if (httpCode > 0) {
    String response = http.getString();
    Serial.println("âœ… Endpoint de verificaciÃ³n funciona");
    Serial.print("ğŸ“¨ Respuesta: ");
    Serial.println(response);
  } else {
    Serial.println("âŒ Endpoint de verificaciÃ³n no funciona");
  }
  
  http.end();
}
